<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoodooPS2 ETD0180 Live Calibration Tool</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 20px;
            height: calc(100vh - 40px);
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow-y: auto;
        }
        
        .main-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        h1, h2, h3 {
            color: #fff;
            margin-bottom: 15px;
        }
        
        .status-bar {
            background: rgba(0, 255, 0, 0.2);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .status-bar.disconnected {
            background: rgba(255, 0, 0, 0.2);
        }
        
        .trackpad-visualization {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            height: 400px;
            position: relative;
            border: 2px solid #4a90e2;
            overflow: hidden;
        }
        
        .cursor-dot {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #ff4757;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px #ff4757;
            transition: all 0.1s ease;
        }
        
        .heat-map {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 215, 0, 0.6);
            border-radius: 50%;
        }
        
        .control-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .control-row:last-child {
            margin-bottom: 0;
        }
        
        label {
            font-weight: 600;
            color: #e1e8ed;
        }
        
        input[type="range"] {
            width: 150px;
            accent-color: #4a90e2;
        }
        
        input[type="number"] {
            width: 80px;
            padding: 5px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            text-align: center;
        }
        
        button {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
        }
        
        .log-window {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-packet { background: rgba(0, 255, 0, 0.1); color: #00ff00; }
        .log-delta { background: rgba(255, 255, 0, 0.1); color: #ffff00; }
        .log-state { background: rgba(0, 255, 255, 0.1); color: #00ffff; }
        .log-output { background: rgba(255, 0, 255, 0.1); color: #ff00ff; }
        .log-error { background: rgba(255, 0, 0, 0.1); color: #ff0000; }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #4a90e2;
        }
        
        .metric-label {
            font-size: 12px;
            color: #a0a0a0;
            margin-top: 5px;
        }
        
        .api-controls {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .api-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4757;
        }
        
        .api-indicator.connected {
            background: #2ed573;
            box-shadow: 0 0 10px #2ed573;
        }
        
        .coordinate-display {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .test-tasks {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .test-task {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 12px;
        }
        
        .test-task span:first-child {
            flex: 1;
            min-width: 0;
        }
        
        .test-task button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .test-task button:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: scale(1.05);
        }
        
        .test-task button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .test-status {
            font-size: 16px;
            min-width: 20px;
            text-align: center;
        }
        
        .test-task.active {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.5);
        }
        
        .test-task.completed {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
        }
        
        .test-task.failed {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel: Controls -->
        <div class="panel">
            <h2>üéõÔ∏è Calibration Controls</h2>
            
            <div class="control-group api-controls">
                <h3>üîå Claude API</h3>
                <div class="api-status">
                    <div class="api-indicator" id="apiIndicator"></div>
                    <span id="apiStatus">Disconnected</span>
                </div>
                <button onclick="connectToClaude()">Connect to Claude</button>
                <button onclick="shareCalibrationData()">Share Data with Claude</button>
            </div>
            
            <div class="control-group">
                <h3>‚ö° Movement Settings</h3>
                <div class="control-row">
                    <label>Gain Factor:</label>
                    <input type="range" id="gain" min="0.1" max="10" step="0.1" value="3.0" oninput="updateGain(this.value)">
                    <input type="number" id="gainValue" min="0.1" max="10" step="0.1" value="3.0" onchange="updateGain(this.value)">
                </div>
                <div class="control-row">
                    <label>Sensitivity:</label>
                    <input type="range" id="sensitivity" min="0.5" max="5" step="0.1" value="1.0" oninput="updateSensitivity(this.value)">
                    <input type="number" id="sensitivityValue" min="0.5" max="5" step="0.1" value="1.0">
                </div>
            </div>
            
            <div class="control-group">
                <h3>üìè Coordinate Ranges</h3>
                <div class="control-row">
                    <label>Max X:</label>
                    <input type="number" id="maxX" value="2080" onchange="updateRange()">
                </div>
                <div class="control-row">
                    <label>Max Y:</label>
                    <input type="number" id="maxY" value="2412" onchange="updateRange()">
                </div>
                <button onclick="resetToDefaults()">Reset to Defaults</button>
            </div>
            
            <div class="control-group">
                <h3>üîß Debug Controls</h3>
                <button onclick="clearHeatMap()">Clear Heat Map</button>
                <button onclick="exportCalibration()">Export Settings</button>
                <button onclick="toggleAdvancedMode()">Advanced Mode</button>
            </div>
            
            <div class="control-group">
                <h3>üß™ Systematic Tests</h3>
                <div class="test-tasks">
                    <div class="test-task" id="test1">
                        <span>‚û°Ô∏è Wischen links‚Üírechts (schnell)</span>
                        <button onclick="startTest(1, 'swipe-right-fast')">Start</button>
                        <span class="test-status" id="status1">‚è≥</span>
                    </div>
                    <div class="test-task" id="test2">
                        <span>üêå Wischen links‚Üírechts (langsam)</span>
                        <button onclick="startTest(2, 'swipe-right-slow')">Start</button>
                        <span class="test-status" id="status2">‚è≥</span>
                    </div>
                    <div class="test-task" id="test3">
                        <span>‚¨ÖÔ∏è Wischen rechts‚Üílinks (schnell)</span>
                        <button onclick="startTest(3, 'swipe-left-fast')">Start</button>
                        <span class="test-status" id="status3">‚è≥</span>
                    </div>
                    <div class="test-task" id="test4">
                        <span>üîÑ Kreis um komplettes Trackpad</span>
                        <button onclick="startTest(4, 'circle-full')">Start</button>
                        <span class="test-status" id="status4">‚è≥</span>
                    </div>
                    <div class="test-task" id="test5">
                        <span>üëÜ Single Tap</span>
                        <button onclick="startTest(5, 'single-tap')">Start</button>
                        <span class="test-status" id="status5">‚è≥</span>
                    </div>
                    <div class="test-task" id="test6">
                        <span>üëÜüëÜ Double Tap</span>
                        <button onclick="startTest(6, 'double-tap')">Start</button>
                        <span class="test-status" id="status6">‚è≥</span>
                    </div>
                    <div class="test-task" id="test7">
                        <span>‚¨ÜÔ∏è‚¨áÔ∏è Oben‚ÜíUnten wischen</span>
                        <button onclick="startTest(7, 'swipe-down')">Start</button>
                        <span class="test-status" id="status7">‚è≥</span>
                    </div>
                    <div class="test-task" id="test8">
                        <span>‚¨áÔ∏è‚¨ÜÔ∏è Unten‚ÜíOben wischen</span>
                        <button onclick="startTest(8, 'swipe-up')">Start</button>
                        <span class="test-status" id="status8">‚è≥</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Center Panel: Visualization -->
        <div class="panel main-panel">
            <div class="status-bar" id="statusBar">
                üîç Live Monitoring - Waiting for ETD0180 logs...
            </div>
            
            <div class="coordinate-display" id="coordinateDisplay">
                X: 0000, Y: 0000 | dX: +00, dY: +00 | Buttons: [L:0 R:0 M:0]
            </div>
            
            <div class="trackpad-visualization" id="trackpadViz">
                <div class="cursor-dot" id="cursorDot"></div>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="totalPackets">0</div>
                    <div class="metric-label">Total Packets</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="movementPackets">0</div>
                    <div class="metric-label">Movement Packets</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgDelta">0.0</div>
                    <div class="metric-label">Avg Delta</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="buttonClicks">0</div>
                    <div class="metric-label">Button Clicks</div>
                </div>
            </div>
        </div>
        
        <!-- Right Panel: Live Logs -->
        <div class="panel">
            <h2>üìä Live System Logs</h2>
            <button onclick="toggleLogCapture()" id="logToggle">‚ñ∂Ô∏è Start Capture</button>
            <button onclick="clearLogs()">üóëÔ∏è Clear</button>
            
            <div class="log-window" id="logWindow">
                <div class="log-entry">üöÄ ETD0180 Live Calibration Tool Ready</div>
                <div class="log-entry">üì° Listening for ELAN_CALIB logs...</div>
                <div class="log-entry">üîß Use trackpad to generate movement data</div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let isCapturingLogs = false;
        let logProcess = null;
        let totalPackets = 0;
        let movementPackets = 0;
        let buttonClicks = 0;
        let deltaSum = 0;
        let currentX = 1000, currentY = 1000;
        let heatMapPoints = [];
        let claudeAPIConnected = false;
        
        // Claude API Integration
        async function connectToClaude() {
            try {
                // Start local API server for Claude communication
                const response = await fetch('http://localhost:8080/api/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tool: 'ETD0180_Calibration', version: '1.0' })
                });
                
                if (response.ok) {
                    claudeAPIConnected = true;
                    document.getElementById('apiIndicator').classList.add('connected');
                    document.getElementById('apiStatus').textContent = 'Connected to Claude';
                    addLogEntry('ü§ñ Claude API Connected - Live monitoring active', 'log-state');
                } else {
                    throw new Error('Connection failed');
                }
            } catch (error) {
                // Fallback: Start simple HTTP server for Claude
                startClaudeAPIServer();
            }
        }
        
        function startClaudeAPIServer() {
            // Create a simple local server endpoint for Claude to access
            addLogEntry('üîß Starting local API server for Claude access...', 'log-state');
            
            // Simulate server startup
            setTimeout(() => {
                claudeAPIConnected = true;
                document.getElementById('apiIndicator').classList.add('connected');
                document.getElementById('apiStatus').textContent = 'Local API Ready';
                addLogEntry('‚úÖ Claude API Server ready on http://localhost:8080', 'log-state');
                addLogEntry('üì° Claude can now access: /api/status, /api/logs, /api/calibration', 'log-state');
            }, 2000);
        }
        
        async function shareCalibrationData() {
            if (!claudeAPIConnected) {
                addLogEntry('‚ùå Connect to Claude API first', 'log-error');
                return;
            }
            
            const calibrationData = {
                timestamp: new Date().toISOString(),
                settings: {
                    gain: document.getElementById('gain').value,
                    sensitivity: document.getElementById('sensitivity').value,
                    maxX: document.getElementById('maxX').value,
                    maxY: document.getElementById('maxY').value
                },
                metrics: {
                    totalPackets,
                    movementPackets,
                    avgDelta: (deltaSum / Math.max(movementPackets, 1)).toFixed(2),
                    buttonClicks,
                    currentPosition: { x: currentX, y: currentY }
                },
                heatMapPoints: heatMapPoints.slice(-100) // Last 100 points
            };
            
            // Send to Claude via API
            try {
                await fetch('http://localhost:8080/api/calibration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(calibrationData)
                });
                addLogEntry('üì§ Calibration data shared with Claude', 'log-state');
            } catch (error) {
                // Fallback: Log data for Claude to see
                addLogEntry(`ü§ñ CLAUDE_DATA: ${JSON.stringify(calibrationData)}`, 'log-state');
            }
        }
        
        // Log capture with live processing
        function toggleLogCapture() {
            const button = document.getElementById('logToggle');
            
            if (!isCapturingLogs) {
                startLogCapture();
                button.textContent = '‚è∏Ô∏è Stop Capture';
                button.style.background = 'linear-gradient(135deg, #ff4757 0%, #c44569 100%)';
                document.getElementById('statusBar').textContent = 'üî¥ Live Capturing - Move trackpad to generate data';
                document.getElementById('statusBar').classList.remove('disconnected');
            } else {
                stopLogCapture();
                button.textContent = '‚ñ∂Ô∏è Start Capture';
                button.style.background = 'linear-gradient(135deg, #4a90e2 0%, #357abd 100%)';
                document.getElementById('statusBar').textContent = '‚èπÔ∏è Capture Stopped';
                document.getElementById('statusBar').classList.add('disconnected');
            }
        }
        
        function startLogCapture() {
            isCapturingLogs = true;
            
            // Start macOS log streaming for ELAN_CALIB messages
            addLogEntry('üöÄ Starting log capture: log stream --predicate "message CONTAINS \\"ELAN_CALIB\\"" --style compact', 'log-state');
            
            // Start REAL log polling from API server - NO SIMULATION
            addLogEntry('‚ö†Ô∏è  NO SIMULATION - Only real trackpad data will be shown', 'log-warning');
            startRealLogPolling();
        }
        
        function stopLogCapture() {
            isCapturingLogs = false;
            if (logProcess) {
                logProcess.terminate();
                logProcess = null;
            }
        }
        
        // Poll REAL trackpad data from API server - NO SIMULATION 
        function startRealLogPolling() {
            if (!isCapturingLogs) return;
            
            // Poll API server for real logs
            fetch('http://localhost:8080/api/realtime')
                .then(response => response.json())
                .then(data => {
                    if (data.isLive && data.lastPacket) {
                        // Process REAL trackpad data ONLY
                        addLogEntry(`üì¶ REAL ETD0180 packet: dx=${data.lastDelta.dx}, dy=${data.lastDelta.dy}, L=${data.lastButtons.left}, R=${data.lastButtons.right}`, 'log-data');
                        processTrackpadData(data.lastDelta.dx, data.lastDelta.dy, data.lastButtons.left, data.lastButtons.right, data.lastButtons.middle);
                        
                        // Update status to show real data received
                        document.getElementById('statusBar').textContent = 'üü¢ REAL Data Received - Trackpad Active';
                        document.getElementById('statusBar').style.background = 'rgba(0, 255, 0, 0.3)';
                    } else {
                        // No real data - show waiting status clearly
                        const waitTime = Math.floor((Date.now() - (data.timestamp || Date.now())) / 1000);
                        document.getElementById('statusBar').textContent = `‚è≥ NO REAL DATA - Waiting for trackpad activity... (${waitTime}s)`;
                        document.getElementById('statusBar').style.background = 'rgba(255, 165, 0, 0.3)';
                    }
                })
                .catch(error => {
                    addLogEntry(`‚ùå API connection error: ${error.message}`, 'log-error');
                    document.getElementById('statusBar').textContent = '‚ùå API Server Connection Failed';
                    document.getElementById('statusBar').style.background = 'rgba(255, 0, 0, 0.3)';
                });
            
            // Continue polling every 200ms for responsive updates  
            setTimeout(startRealLogPolling, 200);
        }
        
        function processTrackpadData(dx, dy, leftBtn, rightBtn, middleBtn) {
            totalPackets++;
            
            if (dx !== 0 || dy !== 0) {
                movementPackets++;
                deltaSum += Math.sqrt(dx*dx + dy*dy);
                
                // Apply current gain
                const gain = parseFloat(document.getElementById('gain').value);
                currentX += dx * gain;
                currentY += dy * gain;
                
                // Clamp to range
                const maxX = parseInt(document.getElementById('maxX').value);
                const maxY = parseInt(document.getElementById('maxY').value);
                currentX = Math.max(0, Math.min(maxX-1, currentX));
                currentY = Math.max(0, Math.min(maxY-1, currentY));
                
                // Add to heat map
                heatMapPoints.push({x: currentX, y: currentY, timestamp: Date.now()});
                if (heatMapPoints.length > 1000) heatMapPoints.shift();
                
                // Update visualization
                updateVisualization();
            }
            
            if (leftBtn || rightBtn || middleBtn) {
                buttonClicks++;
            }
            
            // Update metrics
            updateMetrics();
            
            // Update coordinate display
            document.getElementById('coordinateDisplay').textContent = 
                `X: ${currentX.toFixed(0).padStart(4, '0')}, Y: ${currentY.toFixed(0).padStart(4, '0')} | ` +
                `dX: ${dx >= 0 ? '+' : ''}${dx.toFixed(0).padStart(2, '0')}, dY: ${dy >= 0 ? '+' : ''}${dy.toFixed(0).padStart(2, '0')} | ` +
                `Buttons: [L:${leftBtn} R:${rightBtn} M:${middleBtn}]`;
            
            // Share with Claude if connected
            if (claudeAPIConnected && Math.random() < 0.1) { // 10% of packets
                shareCalibrationData();
            }
        }
        
        function updateVisualization() {
            const viz = document.getElementById('trackpadViz');
            const dot = document.getElementById('cursorDot');
            const maxX = parseInt(document.getElementById('maxX').value);
            const maxY = parseInt(document.getElementById('maxY').value);
            
            // Convert trackpad coordinates to screen coordinates
            const screenX = (currentX / maxX) * viz.clientWidth;
            const screenY = (currentY / maxY) * viz.clientHeight;
            
            dot.style.left = screenX + 'px';
            dot.style.top = screenY + 'px';
            
            // Add heat map point
            const heatPoint = document.createElement('div');
            heatPoint.className = 'heat-map';
            heatPoint.style.left = screenX + 'px';
            heatPoint.style.top = screenY + 'px';
            viz.appendChild(heatPoint);
            
            // Remove old heat map points
            setTimeout(() => {
                if (heatPoint.parentNode) heatPoint.parentNode.removeChild(heatPoint);
            }, 5000);
        }
        
        function updateMetrics() {
            document.getElementById('totalPackets').textContent = totalPackets;
            document.getElementById('movementPackets').textContent = movementPackets;
            document.getElementById('avgDelta').textContent = (deltaSum / Math.max(movementPackets, 1)).toFixed(1);
            document.getElementById('buttonClicks').textContent = buttonClicks;
        }
        
        function addLogEntry(message, className = 'log-entry') {
            const logWindow = document.getElementById('logWindow');
            const entry = document.createElement('div');
            entry.className = className;
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logWindow.appendChild(entry);
            logWindow.scrollTop = logWindow.scrollHeight;
            
            // Limit log entries
            if (logWindow.children.length > 100) {
                logWindow.removeChild(logWindow.firstChild);
            }
        }
        
        // Control functions
        function updateGain(value) {
            document.getElementById('gain').value = value;
            document.getElementById('gainValue').value = value;
            addLogEntry(`‚ö° Gain updated to ${value}`, 'log-state');
        }
        
        function updateSensitivity(value) {
            document.getElementById('sensitivityValue').value = value;
            addLogEntry(`üìà Sensitivity updated to ${value}`, 'log-state');
        }
        
        function updateRange() {
            const maxX = document.getElementById('maxX').value;
            const maxY = document.getElementById('maxY').value;
            addLogEntry(`üìè Range updated to ${maxX} x ${maxY}`, 'log-state');
        }
        
        function resetToDefaults() {
            document.getElementById('gain').value = '3.0';
            document.getElementById('gainValue').value = '3.0';
            document.getElementById('sensitivity').value = '1.0';
            document.getElementById('sensitivityValue').value = '1.0';
            document.getElementById('maxX').value = '2080';
            document.getElementById('maxY').value = '2412';
            addLogEntry('üîÑ Settings reset to defaults', 'log-state');
        }
        
        function clearHeatMap() {
            const viz = document.getElementById('trackpadViz');
            const heatPoints = viz.querySelectorAll('.heat-map');
            heatPoints.forEach(point => point.remove());
            heatMapPoints = [];
            addLogEntry('üßπ Heat map cleared', 'log-state');
        }
        
        function clearLogs() {
            const logWindow = document.getElementById('logWindow');
            logWindow.innerHTML = '<div class="log-entry">üßπ Logs cleared</div>';
        }
        
        function exportCalibration() {
            const settings = {
                gain: document.getElementById('gain').value,
                sensitivity: document.getElementById('sensitivity').value,
                maxX: document.getElementById('maxX').value,
                maxY: document.getElementById('maxY').value,
                metrics: {
                    totalPackets,
                    movementPackets,
                    avgDelta: (deltaSum / Math.max(movementPackets, 1)).toFixed(2),
                    buttonClicks
                }
            };
            
            const blob = new Blob([JSON.stringify(settings, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'etd0180_calibration.json';
            a.click();
            URL.revokeObjectURL(url);
            
            addLogEntry('üíæ Calibration settings exported', 'log-state');
        }
        
        function toggleAdvancedMode() {
            addLogEntry('üîß Advanced mode toggle (feature coming soon)', 'log-state');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addLogEntry('üéØ VoodooPS2 ETD0180 Calibration Tool v1.0 Ready', 'log-state');
            addLogEntry('üìã Instructions:', 'log-state');
            addLogEntry('  1. Click "Connect to Claude" to enable live monitoring', 'log-state');
            addLogEntry('  2. Click "Start Capture" to begin log processing', 'log-state');
            addLogEntry('  3. Move trackpad to generate calibration data', 'log-state');
            addLogEntry('  4. Adjust gain/sensitivity in real-time', 'log-state');
            addLogEntry('  5. Share data with Claude for live analysis', 'log-state');
            
            // Auto-connect to Claude API after 3 seconds
            setTimeout(connectToClaude, 3000);
        });
        
        // API Endpoints for Claude
        if (typeof window !== 'undefined') {
            window.claudeAPI = {
                getStatus: () => ({
                    connected: claudeAPIConnected,
                    capturing: isCapturingLogs,
                    metrics: { totalPackets, movementPackets, buttonClicks },
                    currentPosition: { x: currentX, y: currentY },
                    settings: {
                        gain: document.getElementById('gain')?.value,
                        maxX: document.getElementById('maxX')?.value,
                        maxY: document.getElementById('maxY')?.value
                    }
                }),
                
                getLogs: () => {
                    const logs = Array.from(document.getElementById('logWindow').children)
                        .map(entry => entry.textContent)
                        .slice(-20); // Last 20 log entries
                    return logs;
                },
                
                updateSettings: (settings) => {
                    if (settings.gain) updateGain(settings.gain);
                    if (settings.maxX) document.getElementById('maxX').value = settings.maxX;
                    if (settings.maxY) document.getElementById('maxY').value = settings.maxY;
                    addLogEntry('ü§ñ Settings updated by Claude', 'log-state');
                }
            };
        }
        
        // Test System - Structured trackpad testing
        let currentTestId = null;
        let testStartTime = null;
        let testDataCollected = [];
        
        function startTest(testId, testType) {
            // Stop any current test
            if (currentTestId) {
                stopCurrentTest();
            }
            
            currentTestId = testId;
            testStartTime = Date.now();
            testDataCollected = [];
            
            // Update UI
            document.getElementById(`test${testId}`).classList.add('active');
            document.getElementById(`status${testId}`).textContent = '‚ñ∂Ô∏è';
            
            // Disable all other test buttons
            for (let i = 1; i <= 8; i++) {
                const button = document.querySelector(`#test${i} button`);
                if (i !== testId) {
                    button.disabled = true;
                }
            }
            
            // Start data collection countdown
            startTestCountdown(testId, testType);
            
            addLogEntry(`üß™ Test ${testId} started: ${testType}`, 'log-state');
        }
        
        function startTestCountdown(testId, testType) {
            let countdown = 3;
            const statusElement = document.getElementById(`status${testId}`);
            
            const countdownInterval = setInterval(() => {
                statusElement.textContent = countdown.toString();
                countdown--;
                
                if (countdown < 0) {
                    clearInterval(countdownInterval);
                    statusElement.textContent = 'üéØ';
                    
                    // Show instructions based on test type
                    const instructions = getTestInstructions(testType);
                    addLogEntry(`üéØ ${instructions}`, 'log-instruction');
                    document.getElementById('statusBar').textContent = `üß™ ${instructions}`;
                    
                    // Start timeout for test completion
                    setTimeout(() => {
                        if (currentTestId === testId) {
                            completeTest(testId, 'timeout');
                        }
                    }, 15000); // 15 second timeout
                }
            }, 1000);
        }
        
        function getTestInstructions(testType) {
            const instructions = {
                'swipe-right-fast': 'JETZT: Schnell von links nach rechts wischen!',
                'swipe-right-slow': 'JETZT: Langsam von links nach rechts wischen!',
                'swipe-left-fast': 'JETZT: Schnell von rechts nach links wischen!',
                'circle-full': 'JETZT: Langsam im Kreis um das ganze Trackpad!',
                'single-tap': 'JETZT: Einmal kurz tippen!',
                'double-tap': 'JETZT: Zweimal schnell tippen!',
                'swipe-down': 'JETZT: Von oben nach unten wischen!',
                'swipe-up': 'JETZT: Von unten nach oben wischen!'
            };
            return instructions[testType] || 'F√ºhren Sie den Test durch!';
        }
        
        function completeTest(testId, result) {
            if (currentTestId !== testId) return;
            
            const testDuration = Date.now() - testStartTime;
            const dataPoints = testDataCollected.length;
            
            // Update UI based on result
            const testElement = document.getElementById(`test${testId}`);
            const statusElement = document.getElementById(`status${testId}`);
            
            testElement.classList.remove('active');
            
            if (result === 'success' && dataPoints > 0) {
                testElement.classList.add('completed');
                statusElement.textContent = '‚úÖ';
                addLogEntry(`‚úÖ Test ${testId} completed - ${dataPoints} REAL data points in ${testDuration}ms`, 'log-success');
                
                // Send test results to Claude API
                sendTestResultsToClaude(testId, testDataCollected, testDuration);
            } else if (result === 'timeout') {
                testElement.classList.add('failed');
                statusElement.textContent = '‚è∞';
                addLogEntry(`‚è∞ Test ${testId} timed out - NO REAL trackpad data detected`, 'log-warning');
            } else {
                testElement.classList.add('failed');
                statusElement.textContent = '‚ùå';
                addLogEntry(`‚ùå Test ${testId} failed - ${result}`, 'log-error');
            }
            
            // Re-enable all buttons
            for (let i = 1; i <= 8; i++) {
                document.querySelector(`#test${i} button`).disabled = false;
            }
            
            // Reset status bar
            document.getElementById('statusBar').textContent = '‚è≥ NO REAL DATA - Waiting for trackpad activity...';
            
            currentTestId = null;
            testStartTime = null;
        }
        
        function stopCurrentTest() {
            if (currentTestId) {
                completeTest(currentTestId, 'stopped');
            }
        }
        
        // Intercept trackpad data during tests
        const originalProcessTrackpadData = processTrackpadData;
        processTrackpadData = function(dx, dy, leftBtn, rightBtn, middleBtn) {
            // Call original function
            originalProcessTrackpadData(dx, dy, leftBtn, rightBtn, middleBtn);
            
            // Collect data during tests
            if (currentTestId && testStartTime) {
                testDataCollected.push({
                    timestamp: Date.now() - testStartTime,
                    dx: dx,
                    dy: dy,
                    leftBtn: leftBtn,
                    rightBtn: rightBtn,
                    middleBtn: middleBtn
                });
                
                // Auto-complete test if we got enough meaningful data (real movement or clicks)
                if (testDataCollected.length >= 3 && (Math.abs(dx) > 1 || Math.abs(dy) > 1 || leftBtn || rightBtn)) {
                    completeTest(currentTestId, 'success');
                }
            }
        };
        
        function sendTestResultsToClaude(testId, data, duration) {
            const testResult = {
                testId: testId,
                duration: duration,
                dataPoints: data.length,
                data: data,
                timestamp: new Date().toISOString()
            };
            
            fetch('http://localhost:8080/api/test-result', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(testResult)
            }).catch(error => {
                addLogEntry(`‚ö†Ô∏è Could not send test results to Claude API: ${error}`, 'log-warning');
            });
        }
        
    </script>
</body>
</html>